<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | QR èª­ã¿å–ã‚Š JS ç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    header {
      background: #111827;
      color: #f9fafb;
      padding: 14px 18px;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.icon {
      font-size: 20px;
    }

    header small {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      color: #d1d5db;
    }

    /* ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ¼ */
    #auth-bar {
      background: #111827;
      border-top: 1px solid #374151;
      padding: 4px 18px 8px;
    }

    main {
      max-width: 1000px;
      margin: 16px auto 32px;
      padding: 0 12px;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(15,23,42,0.06);
      padding: 14px 16px;
      margin-bottom: 14px;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h2 span.icon {
      font-size: 16px;
    }

    .card p.desc {
      margin: 0 0 8px;
      font-size: 12px;
      color: #6b7280;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 6px 10px;
      font-size: 13px;
    }

    .info-item-label {
      font-size: 11px;
      color: #6b7280;
    }

    .info-item-value {
      font-size: 13px;
      font-weight: 500;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      font-size: 11px;
      padding: 2px 8px;
    }

    .badge-status-active {
      background: #dcfce7;
      color: #166534;
    }
    .badge-status-inactive {
      background: #fee2e2;
      color: #b91c1c;
    }
    .badge-plan {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .configs-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .configs-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 2px;
      gap: 2px;
    }

    .configs-tab {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: #4b5563;
    }

    .configs-tab.active {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    .config-list-empty {
      font-size: 12px;
      color: #9ca3af;
      padding: 4px 0 2px;
    }

    table.config-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }

    table.config-table thead {
      background: #f3f4f6;
    }

    table.config-table th,
    table.config-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    table.config-table th {
      font-weight: 600;
      color: #4b5563;
      font-size: 11px;
    }

    table.config-table td.actions {
      white-space: nowrap;
    }

    .btn-link {
      border: none;
      background: none;
      color: #2563eb;
      font-size: 11px;
      cursor: pointer;
      padding: 0 4px;
      text-decoration: underline;
    }

    .btn-link.danger {
      color: #b91c1c;
    }

    .small-note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .generator-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
      font-size: 11px;
    }

    .generator-links a {
      color: #2563eb;
      text-decoration: none;
    }

    .generator-links a:hover {
      text-decoration: underline;
    }

    .message {
      font-size: 13px;
      color: #374151;
    }

    .message.notice {
      color: #6b7280;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <span class="icon">ğŸ‘¤</span>
      ãƒã‚¤ãƒšãƒ¼ã‚¸
    </h1>
    <small>ã”åˆ©ç”¨ä¸­ã®ãƒ—ãƒ©ãƒ³ã¨ã€ä¿å­˜ã•ã‚ŒãŸ JS ç”Ÿæˆè¨­å®šã‚’ç¢ºèªã§ãã¾ã™ã€‚</small>
  </header>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ¼ï¼ˆauth.js ãŒä¸­èº«ã‚’æç”»ï¼‰ -->
  <div id="auth-bar"></div>

  <main>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <section class="card" id="my-login-message">
      <h2><span class="icon">ğŸ”</span>ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹</h2>
      <p class="message">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ç¢ºèªä¸­ã§ã™â€¦</p>
    </section>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
    <section class="card" id="my-user-card" style="display:none;">
      <h2><span class="icon">ğŸ§¾</span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h2>
      <p class="desc">Firebase / Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
      <div class="info-grid" id="my-user-info"></div>
      <p class="small-note">
        â€» status ãŒ <strong>inactive</strong> ã®å ´åˆã€å„ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢ã§ JS å‡ºåŠ›ãŒã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
      </p>
    </section>

    <!-- è¨­å®šä¸€è¦§ -->
    <section class="card" id="my-config-card" style="display:none;">
      <div class="configs-section-header">
        <h2><span class="icon">ğŸ§©</span>ä¿å­˜æ¸ˆã¿è¨­å®š</h2>
        <div class="configs-tabs" id="my-config-tabs">
          <button class="configs-tab active" data-mode="simple">å˜ç´”åŒºåˆ‡ã‚Š</button>
          <button class="configs-tab" data-mode="kv">ã‚­ãƒ¼å‹</button>
          <button class="configs-tab" data-mode="fixed">æ–‡å­—æ•°åŒºåˆ‡ã‚Š</button>
        </div>
      </div>
      <p class="desc">
        å„ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢ã§ä¿å­˜ã—ãŸè¨­å®šã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ã€‚<br />
        ç·¨é›†ã—ãŸã„å ´åˆã¯ã€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢ã‚’é–‹ãã€ã€Œä¿å­˜æ¸ˆã¿è¨­å®šã€ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚
      </p>

      <div id="my-config-list"></div>

      <div class="generator-links">
        <!-- å®Ÿéš›ã®ãƒ‘ã‚¹ã«åˆã‚ã›ã¦ href ã¯æ›¸ãæ›ãˆOK -->
        <span>â–¶ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢ã¸ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼š</span>
        <a href="index-sd.html">å˜ç´”åŒºåˆ‡ã‚Š</a>
        <a href="index-kv.html">ã‚­ãƒ¼å‹</a>
        <a href="index-fw.html">æ–‡å­—æ•°åŒºåˆ‡ã‚Š</a>
      </div>
      <p class="small-note">
        â€» ã“ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ã¯è¨­å®šã®<strong>å‰Šé™¤</strong>ã®ã¿è¡Œãˆã¾ã™ï¼ˆç”Ÿæˆã‚„ç·¨é›†ã¯å„ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢ã§è¡Œã£ã¦ãã ã•ã„ï¼‰ã€‚
      </p>
    </section>
  </main>

  <!-- å…ˆã« auth.js ã‚’èª­ã¿è¾¼ã¿ï¼ˆtanaAuth ã‚’ä½œã‚‹ï¼‰ -->
  <script type="module" src="auth.js"></script>

  <!-- ã¤ã¥ã‘ã¦ mypage ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§èª­ã¿è¾¼ã¿ -->
  <script type="module">
    import {
      collection,
      getDocs,
      deleteDoc,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    function $(id) {
      return document.getElementById(id);
    }

    // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æç”» =====
    function renderUserInfo(user, userDocData) {
      const card = $("my-user-card");
      const container = $("my-user-info");
      if (!card || !container) return;

      if (!user) {
        card.style.display = "none";
        return;
      }
      card.style.display = "";

      container.innerHTML = "";

      const items = [];

      items.push({
        label: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
        value: user.email || "(æœªè¨­å®š)"
      });

      items.push({
        label: "UID",
        value: user.uid
      });

      const status = userDocData && userDocData.status ? String(userDocData.status) : "unknown";
      const plan   = userDocData && userDocData.plan   ? String(userDocData.plan)   : "free";

      const statusHtml =
        status === "active"
          ? '<span class="badge badge-status-active">status: active</span>'
          : status === "inactive"
          ? '<span class="badge badge-status-inactive">status: inactive</span>'
          : `<span class="badge badge-status-inactive">status: ${status}</span>`;

      const planHtml = `<span class="badge badge-plan">plan: ${plan}</span>`;

      items.push({ label: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", value: statusHtml, isHtml: true });
      items.push({ label: "ãƒ—ãƒ©ãƒ³",    value: planHtml,   isHtml: true });

      if (userDocData && userDocData.createdAt && userDocData.createdAt.toDate) {
        items.push({
          label: "ç™»éŒ²æ—¥æ™‚",
          value: userDocData.createdAt.toDate().toLocaleString()
        });
      }
      if (userDocData && userDocData.updatedAt && userDocData.updatedAt.toDate) {
        items.push({
          label: "æ›´æ–°æ—¥æ™‚",
          value: userDocData.updatedAt.toDate().toLocaleString()
        });
      }

      for (const item of items) {
        const wrap = document.createElement("div");
        const lab = document.createElement("div");
        lab.className = "info-item-label";
        lab.textContent = item.label;
        const val = document.createElement("div");
        val.className = "info-item-value";
        if (item.isHtml) {
          val.innerHTML = item.value;
        } else {
          val.textContent = item.value;
        }
        wrap.appendChild(lab);
        wrap.appendChild(val);
        container.appendChild(wrap);
      }
    }

    // ===== è¨­å®šä¸€è¦§ã®æç”» =====
    function modeLabel(mode) {
      switch (mode) {
        case "simple": return "å˜ç´”åŒºåˆ‡ã‚Š";
        case "kv":     return "ã‚­ãƒ¼å‹";
        case "fixed":  return "æ–‡å­—æ•°åŒºåˆ‡ã‚Š";
        default:       return mode || "(ä¸æ˜)";
      }
    }

    function renderConfigList(allConfigs, activeMode) {
      const card = $("my-config-card");
      const container = $("my-config-list");
      if (!card || !container) return;

      if (!allConfigs || allConfigs.length === 0) {
        card.style.display = "none";
        return;
      }
      card.style.display = "";

      container.innerHTML = "";

      const filtered = allConfigs.filter(c => c.mode === activeMode);
      if (!filtered.length) {
        const div = document.createElement("div");
        div.className = "config-list-empty";
        div.textContent = "ã“ã®ç¨®é¡ã®è¨­å®šã¯ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        container.appendChild(div);
        return;
      }

      const table = document.createElement("table");
      table.className = "config-table";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>è¨­å®šå</th>
          <th>ãƒ¢ãƒ¼ãƒ‰</th>
          <th>ä½œæˆæ—¥æ™‚</th>
          <th>æ›´æ–°æ—¥æ™‚</th>
          <th>æ“ä½œ</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      filtered.forEach(cfg => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = cfg.name || "(ç„¡é¡Œ)";

        const tdMode = document.createElement("td");
        tdMode.textContent = modeLabel(cfg.mode);

        const tdCreated = document.createElement("td");
        tdCreated.textContent = cfg.createdAt || "";

        const tdUpdated = document.createElement("td");
        tdUpdated.textContent = cfg.updatedAt || "";

        const tdActions = document.createElement("td");
        tdActions.className = "actions";
        const delBtn = document.createElement("button");
        delBtn.className = "btn-link danger";
        delBtn.textContent = "å‰Šé™¤";
        delBtn.dataset.id = cfg.id;
        delBtn.addEventListener("click", () => onDeleteConfig(cfg));
        tdActions.appendChild(delBtn);

        tr.appendChild(tdName);
        tr.appendChild(tdMode);
        tr.appendChild(tdCreated);
        tr.appendChild(tdUpdated);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    // ===== Firestore ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾— =====
    async function fetchUserDoc(db, uid) {
      try {
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) return null;
        return snap.data();
      } catch (e) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", e);
        return null;
      }
    }

    async function fetchConfigs(db, uid) {
      const results = [];
      try {
        const colRef = collection(db, "users", uid, "configs");
        const snap = await getDocs(colRef);
        snap.forEach(docSnap => {
          const data = docSnap.data() || {};
          const createdAt =
            data.createdAt && data.createdAt.toDate
              ? data.createdAt.toDate().toLocaleString()
              : "";
          const updatedAt =
            data.updatedAt && data.updatedAt.toDate
              ? data.updatedAt.toDate().toLocaleString()
              : "";
          results.push({
            id: docSnap.id,
            name: data.name || "",
            mode: data.mode || "",
            createdAt,
            updatedAt
          });
        });
      } catch (e) {
        console.error("è¨­å®šä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
      }
      return results;
    }

    async function onDeleteConfig(cfg) {
      const auth = window.tanaAuth;
      const user = auth && auth.currentUser;
      const db   = auth && auth.db;

      if (!user || !db) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
        return;
      }

      const ok = window.confirm(
        `è¨­å®šã€Œ${cfg.name || "(ç„¡é¡Œ)"}ã€ï¼ˆ${modeLabel(cfg.mode)}ï¼‰ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`
      );
      if (!ok) return;

      try {
        const ref = doc(db, "users", user.uid, "configs", cfg.id);
        await deleteDoc(ref);
        alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        await refreshPage();
      } catch (e) {
        console.error("è¨­å®šå‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    // ===== å…¨ä½“ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ =====
    let cachedConfigs = [];
    let activeMode = "simple";

    async function refreshPage() {
      const loginCard = $("my-login-message");
      const msgEl = loginCard && loginCard.querySelector(".message");
      const userCard = $("my-user-card");
      const configCard = $("my-config-card");

      const auth = window.tanaAuth;
      const user = auth && auth.currentUser;
      const db   = auth && auth.db;

      if (!user || !db) {
        if (msgEl) {
          msgEl.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚å³ä¸Šã®ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ¼ã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
        }
        if (userCard) userCard.style.display = "none";
        if (configCard) configCard.style.display = "none";
        return;
      }

      if (msgEl) {
        msgEl.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email || "(email ãªã—)"}`;
      }

      const [userDocData, configs] = await Promise.all([
        fetchUserDoc(db, user.uid),
        fetchConfigs(db, user.uid)
      ]);

      renderUserInfo(user, userDocData);

      cachedConfigs = configs;
      renderConfigList(cachedConfigs, activeMode);
    }

    // ===== ã‚¿ãƒ–åˆ‡æ›¿ =====
    function setupTabs() {
      const tabsContainer = $("my-config-tabs");
      if (!tabsContainer) return;

      const tabs = Array.from(tabsContainer.querySelectorAll(".configs-tab"));
      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          const mode = tab.dataset.mode;
          activeMode = mode || "simple";

          tabs.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");

          renderConfigList(cachedConfigs, activeMode);
        });
      });
    }

    // ===== åˆæœŸåŒ– =====
    function initMyPage() {
      setupTabs();

      if (window.tanaAuth && typeof window.tanaAuth.onChange === "function") {
        window.tanaAuth.onChange(() => {
          refreshPage();
        });
      }

      refreshPage();
    }

    document.addEventListener("DOMContentLoaded", initMyPage);
  </script>
</body>
</html>
